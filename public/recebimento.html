<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Supermercado - Recebimento de Mercadorias</title>
    <style>
        /* [ESTILOS CSS OMITIDOS PARA CONCIS√ÉO, SEM ALTERA√á√ÉO] */
/* Estilos Gerais para Recebimento */
body {
    font-family: Arial, sans-serif;
    background-color: #f0f2f5;
    margin: 0;
    padding: 20px;
}

.recebimento-container {
    max-width: 900px;
    margin: 0 auto;
    background-color: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

h1 {
    color: #007bff;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.xml-upload-area {
    background-color: #e9f7ff;
    padding: 20px;
    border: 1px dashed #007bff;
    border-radius: 6px;
    margin-bottom: 30px;
}

.xml-upload-area label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
    color: #007bff;
}

#fileInput {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
}

#notaFiscalInfo {
    margin-bottom: 30px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 6px;
}

#notaFiscalInfo h2 {
    color: #343a40;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.nf-summary p {
    margin: 5px 0;
}

.nf-summary p strong {
    color: #007bff;
}

.nf-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.nf-items-table th, .nf-items-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 0.9em;
}

.nf-items-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}

.action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

.action-buttons button {
    padding: 12px 25px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
}

#confirmBtn {
    background-color: #28a745;
    color: white;
}

#confirmBtn:hover {
    background-color: #1e7e34;
}

#cancelBtn {
    background-color: #dc3545;
    color: white;
}

#cancelBtn:hover {
    background-color: #c82333;
}

#feedbackMessage {
    margin-top: 20px;
    text-align: center;
    font-weight: bold;
    color: #007bff;
}
    </style>
</head>
<body>

    <div class="recebimento-container">
        <h1>Recebimento de Mercadorias</h1>

        <div class="xml-upload-area">
            <label for="fileInput">1. Carregar Arquivo XML da Nota Fiscal (NF-e)</label>
            <input type="file" id="fileInput" accept=".xml">
        </div>

        <div id="notaFiscalInfo" style="display: none;">
            <h2>Detalhes da NF-e</h2>

            <div class="nf-summary">
                <p><strong>N√∫mero da NF:</strong> <span id="nfNumero"></span></p>
                <p><strong>Emitente (Fornecedor):</strong> <span id="nfEmitente"></span></p>
                <p><strong>Valor Total:</strong> <span id="nfValorTotal"></span></p>
            </div>

            <h3>Itens Recebidos:</h3>
            <table class="nf-items-table">
                <thead>
                    <tr>
                        <th>C√≥d. Produto</th>
                        <th>Descri√ß√£o</th>
                        <th>Qtd</th>
                        <th>Valor Unit√°rio (Custo)</th>
                    </tr>
                </thead>
                <tbody id="nfItemsBody">
                    </tbody>
            </table>
        </div>

        <div class="action-buttons" style="display: none;">
            <button id="cancelBtn" onclick="cancelRecebimento()">Cancelar Recebimento</button>
            <button id="confirmBtn" onclick="confirmRecebimento()">Confirmar Entrada no Estoque</button>
        </div>

        <p id="feedbackMessage"></p>
    </div>

<script>
    // Vari√°veis globais (carregadas da sess√£o)
    let operadorMatricula = null;
    let operadorNome = null;
    let operadorToken = null; // NOVO: Token JWT
    let notaFiscalData = null; // Armazena temporariamente os dados da NF-e validada

    // ==========================================================
    // üîê FUN√á√ÉO CR√çTICA: GERA HEADERS DE AUTORIZA√á√ÉO
    // ==========================================================
    function getAuthHeaders() {
        // Envia o token no formato padr√£o JWT: Authorization: Bearer <token>
        return {
            'Authorization': `Bearer ${operadorToken}`
        };
    }

    function blockModule() {
        sessionStorage.clear();
        window.location.href = 'index.html'; // Limpa a sess√£o e redireciona para o login
    }


    // ==========================================================
    // 1. FUN√á√ïES DE PROCESSAMENTO E CONFER√äNCIA
    // ==========================================================

    // Fun√ß√£o para tratar a leitura do arquivo XML (apenas l√™, n√£o envia)
    function handleFileUpload(event) {
        const file = event.target.files[0];
        const feedback = document.getElementById('feedbackMessage');
        feedback.textContent = '';

        if (!file) {
            cancelRecebimento();
            return;
        }

        if (file.name.toLowerCase().endsWith('.xml')) {
            feedback.textContent = `Carregando arquivo ${file.name}...`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const xmlContent = e.target.result;
                await sendXmlToValidation(xmlContent); // Chama a valida√ß√£o no backend
            };
            reader.readAsText(file);
        } else {
            feedback.textContent = '‚ùå Por favor, selecione um arquivo XML v√°lido.';
            document.getElementById('fileInput').value = '';
            cancelRecebimento();
        }
    }

    // Fun√ß√£o CR√çTICA: Envia o XML para o Backend para valida√ß√£o
    async function sendXmlToValidation(xmlContent) {
        const feedback = document.getElementById('feedbackMessage');
        feedback.textContent = 'Enviando NF-e para valida√ß√£o no backend...';

        try {
            const response = await fetch('/api/erp/recebimento/validar_nfe', {
                method: 'POST',
                // Apenas Content-Type: application/json e Authorization s√£o necess√°rios
                headers: {
                    ...getAuthHeaders(), // <-- ADI√á√ÉO CR√çTICA
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ xml_content: xmlContent })
            });

            const data = await response.json();

            // Tratamento de falha de autoriza√ß√£o
            if (response.status === 401 || response.status === 403) {
                alert(`Sess√£o expirada ou acesso negado: ${data.message}. Redirecionando para login.`);
                blockModule();
                return;
            }

            if (response.ok && data.success) {
                notaFiscalData = data.nota_fiscal;
                renderNotaFiscalInfo(notaFiscalData);
                feedback.textContent = `‚úÖ NF-e ${notaFiscalData.nf_numero} do Fornecedor ${notaFiscalData.fornecedor_nome} validada. Revise e Confirme.`;

                document.getElementById('notaFiscalInfo').style.display = 'block';
                document.querySelector('.action-buttons').style.display = 'flex';
                document.querySelector('.xml-upload-area').style.display = 'none';

            } else {
                // Erro na valida√ß√£o da NFe (dados incorretos, XML mal formatado, etc.)
                feedback.textContent = `‚ùå Erro de Valida√ß√£o: ${data.message}`;
                cancelRecebimento();
            }

        } catch (error) {
            console.error('Erro de rede ao validar NF-e:', error);
            feedback.textContent = '‚ö†Ô∏è Erro de conex√£o com o servidor ao tentar validar NF-e.';
            cancelRecebimento();
        }
    }

    // Fun√ß√£o CR√çTICA: Envia confirma√ß√£o para o Backend (Atualiza Estoque/Custo/Financeiro)
    async function confirmRecebimento() {
        if (!notaFiscalData) {
            alert("Nenhuma NF-e carregada para confirmar.");
            return;
        }

        const feedback = document.getElementById('feedbackMessage');
        feedback.textContent = `Confirmando recebimento da NF ${notaFiscalData.nf_numero}... (Aguarde)`;

        try {
            const response = await fetch('/api/erp/recebimento/confirmar', {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(), // <-- ADI√á√ÉO CR√çTICA
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nf_numero: notaFiscalData.nf_numero,
                    fornecedor_cnpj: notaFiscalData.fornecedor_cnpj,
                    produtos: notaFiscalData.produtos // Dados de produtos, custo e quantidade
                })
            });

            const data = await response.json();

            if (response.status === 401 || response.status === 403) {
                alert(`Sess√£o expirada ou acesso negado: ${data.message}. Redirecionando para login.`);
                blockModule();
                return;
            }

            if (response.ok && data.success) {
                feedback.textContent = `‚úÖ SUCESSO! ${data.message}`;
                // Limpeza ap√≥s sucesso
                cancelRecebimento(false);
                document.querySelector('.xml-upload-area').style.display = 'block';
            } else {
                feedback.textContent = `‚ùå FALHA ao confirmar recebimento: ${data.message}`;
            }

        } catch (error) {
            console.error('Erro de rede ao confirmar recebimento:', error);
            feedback.textContent = '‚ö†Ô∏è Erro de conex√£o com o servidor. Recebimento n√£o processado.';
        }
    }

    // Limpa a tela e as vari√°veis locais
    function cancelRecebimento(resetFileInput = true) {
        notaFiscalData = null;
        document.getElementById('notaFiscalInfo').style.display = 'none';
        document.querySelector('.action-buttons').style.display = 'none';
        document.getElementById('nfHeader').textContent = 'Nota Fiscal: N/A';
        document.getElementById('produtosTableBody').innerHTML = '';
        document.getElementById('nfFornecedor').textContent = '';
        document.getElementById('nfTotal').textContent = '';

        if (resetFileInput) {
             document.getElementById('fileInput').value = ''; // Limpa o input file
             document.getElementById('feedbackMessage').textContent = `Pronto para conferir NFs.`;
        }
    }

    // ==========================================================
    // 2. FUN√á√ïES DE RENDERIZA√á√ÉO
    // ==========================================================

    function renderNotaFiscalInfo(nf) {
        document.getElementById('nfHeader').textContent = `Nota Fiscal: ${nf.nf_numero} (S√©rie ${nf.nf_serie})`;
        document.getElementById('nfFornecedor').textContent = `Fornecedor: ${nf.fornecedor_nome} (CNPJ: ${nf.fornecedor_cnpj})`;
        document.getElementById('nfTotal').textContent = `Valor Total da NF: R$ ${nf.valor_total.toFixed(2).replace('.', ',')}`;

        const tableBody = document.getElementById('produtosTableBody');
        tableBody.innerHTML = '';

        nf.produtos.forEach((produto, index) => {
            const row = tableBody.insertRow();

            // Simula√ß√£o de confer√™ncia (Em um sistema real, haveria inputs para confer√™ncia)
            const statusClass = produto.status_conferencia === 'OK' ? 'status-ok' : 'status-alerta';

            row.insertCell(0).textContent = produto.codigo_barra_fornecedor;
            row.insertCell(1).textContent = produto.nome;
            row.insertCell(2).textContent = produto.quantidade_recebida;
            row.insertCell(3).textContent = `R$ ${produto.custo_unitario.toFixed(2).replace('.', ',')}`;
            row.insertCell(4).textContent = `R$ ${(produto.quantidade_recebida * produto.custo_unitario).toFixed(2).replace('.', ',')}`;
            row.insertCell(5).innerHTML = `<span class="${statusClass}">${produto.status_conferencia}</span>`;
        });
    }

    // ==========================================================
    // INICIALIZA√á√ÉO (AGORA SEGURA)
    // ==========================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Carrega dados da sess√£o
        operadorMatricula = sessionStorage.getItem('operadorMatricula');
        operadorNome = sessionStorage.getItem('operadorNome');
        operadorToken = sessionStorage.getItem('operadorToken'); // <-- NOVO: Carrega o Token

        // 1. CR√çTICO: Verifica Autoriza√ß√£o (Precisa de Matr√≠cula E Token)
        if (!operadorMatricula || !operadorToken) {
            alert("Acesso n√£o autorizado. Por favor, fa√ßa o login.");
            blockModule();
            return;
        }

        // 2. Adiciona Listeners de Evento
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('confirmBtn').addEventListener('click', confirmRecebimento);
        document.getElementById('cancelBtn').addEventListener('click', cancelRecebimento);

        // 3. Inicializa a tela
        document.getElementById('notaFiscalInfo').style.display = 'none';
        document.querySelector('.action-buttons').style.display = 'none';
        document.getElementById('feedbackMessage').textContent = `Bem-vindo(a) ${operadorNome}. Pronto para conferir NFs.`;
        document.querySelector('h1').textContent += ` - Logado: ${operadorNome}`;

    });
</script>
</body>
</html>